---
description: Web stack guide for Nextra documentation site (auto-applies in apps/docs/)
---

# Web stack guide

**Applies to:** `apps/docs/` documentation site only

Guide for the Nextra-based AlignTrue docs site: App Router, MDX content, `@aligntrue/ui`, and Vercel deployment. Keep it simple, fast, and boring.

---

## Core principles

1. Use Nextra defaults with minimal custom code.
2. Author content in MDX under `apps/docs/content/`.
3. Use Nextra built-in components where possible.
4. Deploy a single docs site to Vercel at the main domain.
5. Share branding via `@aligntrue/ui`.
6. Prefer changes that stay compatible with Nextra minor upgrades.

---

## Performance and best practices

- Prefer fetching data in RSC (page can still be static)
- Use next/font and next/script when applicable
- next/image above the fold should use `loading="eager"` or `priority` sparingly
- Be mindful of serialized prop size for RSC to child components

---

## Nextra 4.6 App Router setup (critical)

AlignTrue uses Nextra `nextra-theme-docs` with Next.js App Router.

### Theme config

`apps/docs/theme.config.tsx` defines the Nextra theme. Nextra auto-loads this. Do not wire it through `next.config.mjs`.

```tsx
// apps/docs/theme.config.tsx
import { AlignTrueLogo } from "@aligntrue/ui";

const config = {
  logo: <AlignTrueLogo size="md" />,
  project: {
    link: "https://github.com/AlignTrue/aligntrue",
  },
  docsRepositoryBase:
    "https://github.com/AlignTrue/aligntrue/tree/main/apps/docs",
  toc: {
    backToTop: true,
  },
};

export default config;
```

Keep theme config minimal. Complex behavior is handled in the docs layout instead.

### Next.js config

Use Nextra plugin. Do not set theme or themeConfig here. Those are Pages Router only.

```javascript
// apps/docs/next.config.mjs
import nextra from "nextra";

const withNextra = nextra({
  latex: true,
  search: {
    codeblocks: false,
  },
  defaultShowCopyCode: true,
});

export default withNextra({
  output: "export",
  reactStrictMode: true,
  transpilePackages: ["@aligntrue/ui"],
});
```

### App Router layout

Nextra wires most behavior automatically. Use App Router layouts and import Nextra styles in the docs layout only.

**Root layout** (`app/layout.tsx`): Setup SEO, analytics, theming providers. Do NOT import Nextra styles here.

```tsx
// apps/docs/app/layout.tsx (root layout does NOT import Nextra styles)
import type { ReactNode } from "react";
import type { Metadata } from "next";
import { Head } from "nextra/components";
import { ThemeProvider } from "next-themes";
import { Analytics } from "@vercel/analytics/react";

export const metadata: Metadata = {
  title: { default: "AlignTrue", template: "%s – AlignTrue" },
  description:
    "Instantly sync rules across agents, people, projects and teams.",
  // ... additional metadata for SEO, OpenGraph, Twitter
};

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <Head>{/* Analytics and global scripts here */}</Head>
      <body>
        <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
          {children}
          <Analytics />
        </ThemeProvider>
      </body>
    </html>
  );
}
```

**Docs layout** (`app/docs/layout.tsx`): Import Nextra styles and wire theme components.

```tsx
// apps/docs/app/docs/layout.tsx (docs layout imports Nextra styles)
import "nextra-theme-docs/style.css";
import type { ReactNode } from "react";
import { Layout, Navbar } from "nextra-theme-docs";
import { Search } from "nextra/components";
import { getPageMap } from "nextra/page-map";
import themeConfig from "../../theme.config";

export default async function DocsLayout({
  children,
}: {
  children: ReactNode;
}) {
  const pageMap = await getPageMap();
  return (
    <Layout
      pageMap={pageMap}
      navbar={
        <Navbar
          logo={themeConfig.logo}
          projectLink={themeConfig.project.link}
        />
      }
      search={<Search placeholder="Search documentation..." />}
      footer={<DocsFooter />}
      sidebar={{ defaultMenuCollapseLevel: 1, autoCollapse: true }}
    >
      {children}
    </Layout>
  );
}
```

For nested docs layout, use Nextra primitives instead of forking theme config. Wrap, do not reimplement.

### Do not

- Add theme or themeConfig to `nextra()` options.
- Pass a themeConfig prop into `<Layout>`.
- Use legacy `createAlignTrueNextraTheme()` helpers.

If a feature is not in Nextra docs, prefer upgrading Nextra or opening an upstream issue.

---

## Nextra layout and content

### Directory structure

```
apps/docs/
  app/
    layout.tsx                  # Root layout (SEO, analytics, theme provider)
    page.tsx                    # Home page
    docs/
      layout.tsx                # Docs layout (Nextra Layout, styles)
      [[...mdxPath]]/page.tsx   # Dynamic route for all docs pages
  content/
    _meta.js                    # Navigation config
    index.mdx                   # Docs landing
    about.md                    # About page
    00-getting-started/
    01-guides/
    02-customization/
    03-concepts/
    04-reference/
    05-troubleshooting/
    06-contributing/
    07-policies/
    08-development/
  mdx-components.tsx            # Shared MDX components
  theme.config.tsx              # Nextra theme config
  next.config.mjs
  vercel.json
```

### Rules

- Use numeric prefixes for content folders: `00-*`, `01-*`, etc.
- Use `index.mdx` or `index.md` for section roots.
- Keep nesting shallow (max 2 levels within a section).
- Navigation comes from `_meta.json` files in each folder.
- Add `about.md` at content root for landing info.

---

## MDX authoring

### Frontmatter

Every page:

```markdown
---
title: Getting started
description: Quick intro to AlignTrue
---

# Getting started
```

### Components

Prefer Nextra components. Re-export them in `mdx-components.tsx` for consistency:

```jsx
import { Callout, Cards, Tabs, Steps } from "nextra/components"
import { Mermaid } from "@theguild/remark-mermaid/mermaid";

<Callout type="info">This is informational.</Callout>

<Cards>
  <Cards.Card title="Core" href="/concepts/architecture" />
  <Cards.Card title="CLI" href="/reference/cli" />
</Cards>

<Tabs items={["Option 1", "Option 2"]}>
  <Tabs.Tab>Content for option 1</Tabs.Tab>
  <Tabs.Tab>Content for option 2</Tabs.Tab>
</Tabs>

<Steps>
  ### Step 1
  Do this first
  ### Step 2
  Do this second
</Steps>

<Mermaid>{`graph LR
  A --> B
`}</Mermaid>
```

### Guidelines

- Use semantic MDX, not custom divs.
- Short sections, concrete examples.
- No marketing fluff. Neutral and factual, per documentation standards.

---

## Images and media

- Use `next/image` in MDX.
- Always specify width and height.
- Prefer SVG or small assets.
- No raw `<img>` without dimensions.

```jsx
import Image from "next/image";
import hero from "./hero.png";

<Image src={hero} alt="AlignTrue overview" width={960} height={540} priority />;
```

---

## Performance budgets (docs)

### Per initial route (gzipped)

| Type          | Limit    |
| ------------- | -------- |
| JavaScript    | ≤ 150 KB |
| CSS           | ≤ 50 KB  |
| Single image  | ≤ 200 KB |
| Fonts (total) | ≤ 150 KB |

If a change exceeds a budget, explain in the PR and file a follow up.

### Web vitals targets (mobile p75)

- LCP ≤ 2.5 s
- INP ≤ 200 ms
- CLS ≤ 0.10
- TTFB ≤ 800 ms

Breaking these in production blocks release.

---

## Vercel deployment

Single docs app deployed to `aligntrue.ai`.

### Setup

- Use Vercel Development, Preview, Production envs.
- Never commit `.env*`.
- Client env vars must start with `NEXT_PUBLIC_`.
- Document env usage in `documentation.mdc`.

### Minimal vercel.json

Include security headers and redirects for old URLs. Actual config also includes:

- `buildCommand`, `devCommand`, `installCommand` (explicit commands for reproducibility)
- `framework: "nextjs"` (explicit Next.js framework)
- `regions: ["iad1"]` (specific region for latency)
- Permanent redirects (`301`) for renamed docs pages
- Security headers: `X-Frame-Options`, `X-Content-Type-Options`, `Referrer-Policy`, `Strict-Transport-Security`

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "pnpm build",
  "framework": "nextjs",
  "redirects": [
    {
      "source": "/quickstart",
      "destination": "/docs/00-getting-started/00-quickstart",
      "permanent": true
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        }
      ]
    }
  ]
}
```

### Each PR

- Must have a Preview URL.
- Must not depend on Production-only secrets.

---

## Logging and analytics

- Use server console logs as structured lines.
- Keep browser logs minimal and non-sensitive.
- If using Vercel Analytics, wire it in `app/layout.tsx` once.
- Configure external log drains only for Production.

---

## Accessibility

- Use `plugin:jsx-a11y/recommended` for docs app.
- All interactive elements keyboard accessible.
- Respect WCAG AA contrast.
- Prefer native semantics, minimal `aria-*`.

Optional Playwright + axe check is encouraged for root and key pages.

---

## Pre merge checks for docs

Run from repo root:

```bash
pnpm lint
pnpm --filter docs build
```

### Optional

```bash
pnpm --filter docs exec playwright test
```

If checks fail on performance or a11y, note it in the PR with a plan.
