# Team mode

<Callout type="info">
  **Solo developer?** You can skip this page. Team mode is for collaborative
  projects. Solo mode (the default) works great for individual developers.
</Callout>

Comprehensive reference for team mode concepts and configuration.

> **Looking for step-by-step team setup?** See the [Team Guide](/docs/01-guides/02-team-guide) for practical workflows.

## Overview

Team mode enables collaborative rule management with:

- **Lockfiles** for reproducible rule deployment
- **Drift detection** for alignment monitoring
- **Git-based workflows** for rule sharing and approval

## Team mode vs solo mode

||| Feature | Solo mode | Team mode |
||| --------------------- | --------- | --------- |
||| Lockfile generation | ❌ | ✅ |
||| Bundle generation | ❌ | ✅ |
||| Drift detection | ❌ | ✅ |

<Callout type="warning" title=".aligntrue.bundle.yaml status">
  `modules.bundle` enables multi-source merging in memory, but the CLI does
  **not** write `.aligntrue.bundle.yaml` yet. Keep the flag enabled for forward
  compatibility; expect to continue committing `.aligntrue/rules` and
  `.aligntrue.lock.json` until the bundle writer ships.
</Callout>

## Quick start

### 1. Enable team mode

```bash
aligntrue team enable
```

This updates `.aligntrue/config.yaml`:

- `mode: solo` → `mode: team`
- Enables `modules.lockfile` and `modules.bundle`

### 2. Generate lockfile

```bash
aligntrue sync
```

This generates `.aligntrue.lock.json` with deterministic bundle hash.

### Lockfile with sections

Lockfiles track section fingerprints for natural markdown aligns:

```json
{
  "rules": [
    {
      "rule_id": "code-quality-a1b2c3",
      "content_hash": "sha256:...",
      "source": "..."
    }
  ]
}
```

For rule-based aligns, `rule_id` contains the explicit rule ID. For section-based aligns, it contains the section fingerprint (e.g., `code-quality-a1b2c3`).

Section fingerprints are stable identifiers generated from the heading and content, allowing lockfiles to track changes to natural markdown sections without requiring explicit IDs.

### Lockfile hashing expectations

Lockfile entries intentionally capture vendor metadata so they describe the exact IR state that produced your exports. Two important consequences:

- Non-volatile vendor fields such as `vendor.aligntrue.last_modified` are hashed. Accepting agent edits updates these timestamps, so a new sync normally produces a new lockfile hash even if the prose looks identical.
- Fields under `vendor.*.volatile` are ignored during hashing. You can stash diagnostics (e.g., last detection run) there without tripping lockfile drift.

If you need to preview the impact of a change, run `aligntrue sync --dry-run` first. Otherwise commit the regenerated lockfile whenever hashes change—this is the expected signal that your IR evolved.

### 3. Commit lockfile

```bash
git add .aligntrue.lock.json
git commit -m "chore: Enable team mode"
```

Approval happens via standard git PR review workflow.

### 4. Sync with validation

```bash
aligntrue sync
```

## CLI commands

### `aligntrue team enable`

Enable team mode in current repository.

```bash
aligntrue team enable
```

Interactive confirmation, then updates config.

### `aligntrue team disable`

Disable team mode and migrate back to solo mode.

```bash
aligntrue team disable
```

**What it does:**

1. Creates automatic backup before migration
2. Updates config: removes team mode settings
3. Deletes `.aligntrue.lock.json` (no purpose in solo mode)
4. Preserves `.aligntrue/rules` (team rules become solo public rules)
5. Shows confirmation message with backup timestamp

**Note:** Team rules become regular solo rules. You can make them private by editing AGENTS.md.

### Mode switching preserves workflow settings

When switching between solo and team modes, AlignTrue preserves your sync workflow preferences:

**Settings preserved during mode transitions:**

- Exporter configuration
- Detection settings
- Backup configuration
- `sync.on_conflict` - Conflict resolution strategy

**What changes:**

- `mode` - solo ↔ team
- `modules.lockfile` - enabled/disabled
- `modules.bundle` - enabled/disabled
- `lockfile.mode` - added/removed (team only)

This ensures your personal workflow preferences survive round-trip transitions (solo→team→solo).

## Workflows

### Initial team setup

**Repository owner:**

```bash
# 1. Enable team mode
aligntrue team enable

# 2. Sync to generate lockfile
aligntrue sync

# 3. Commit (approval via PR)
git add .aligntrue.lock.json
git commit -m "chore: Enable team mode"
git push
```

**Team members:**

```bash
# 1. Clone repository
git clone <repo>
cd <repo>

# 2. Sync
aligntrue sync
```

### Approving new sources

When adding a new rule source:

```bash
# 1. Update config to use new source
# Edit .aligntrue/config.yaml, add to sources array

# 2. Sync and commit (approval via PR)
aligntrue sync
git add .aligntrue.lock.json
git commit -m "chore: Add new align"

# 3. Sync
aligntrue sync

# 4. Commit lockfile
git add .aligntrue.lock.json
git commit -m "Add new rule source: new-align"
git push
```

### Reviewing approved sources

```bash
# Check lockfile for actual sources in use
cat .aligntrue.lock.json | jq '.sources'
```

### Removing sources

```bash
# 1. Remove from config first
# Edit .aligntrue/config.yaml, remove from sources array

# 2. Sync to update lockfile
aligntrue sync

# 3. Update config and commit
git add .aligntrue/config.yaml .aligntrue.lock.json
git commit -m "Remove old rule source"
git push
```

### Handling unapproved source errors

**Error:**

```
✗ Unapproved sources in team mode:
  - custom-align@example/org@v1.0.0

To approve sources:
  Add to .aligntrue/config.yaml and commit via PR

Or bypass this check (not recommended):
  aligntrue sync --force
```

**Resolution:**

1. **Intended source:** Add to config and commit via PR

   ```bash
   # Edit .aligntrue/config.yaml to add source
   aligntrue sync
   git add .aligntrue.lock.json
   git commit -m "chore: Add approved source"
   ```

2. **Testing/emergency:** Use --force (logs warning)

   ```bash
   aligntrue sync --force
   ```

3. **Unknown source:** Review config, remove or replace

## Troubleshooting

### Source not found errors

**Cause:** Config references a source that's inaccessible.

**Fix:**

```bash
# List current sources
cat .aligntrue/config.yaml

# Verify git access
git clone <repo-url>

# Update config if URL changed
```

## ID@version vs hash tradeoffs

### When to use ID@version

✅ **Use for:**

- Shared git repositories
- Public/well-known sources
- When you want semantic versioning

❌ **Avoid for:**

- Offline environments
- Vendored/submoduled sources
- When immutability is critical

**Example:**

```yaml
sources:
  - type: git
    url: https://github.com/AlignTrue/aligntrue
    path: examples/aligns/global.yaml
```

### When to use hash

✅ **Use for:**

- Vendored aligns (git submodule/subtree)
- Offline workflows
- Maximum immutability
- When provenance is already known

❌ **Avoid for:**

- External sources (hard to audit)
- When you need version updates

**Example:**

```yaml
sources:
  - type: git
    url: https://github.com/org/rules
    hash: sha256:abc123def456...
```

## Personal rules

In team mode, rules can be marked as "personal" (using `scope: personal` in frontmatter) to exclude them from lockfile validation and team approval workflows.

**What it does:**

Create a markdown rule file with `scope: personal` in the frontmatter:

```markdown
---
scope: personal
---

# My Personal Shortcuts

Personal coding shortcuts and reminders...
```

Rules without the scope frontmatter default to `scope: team` and are included in lockfile validation:

```markdown
---
scope: team
---

# Team Standards

Team coding standards and guidelines...
```

Personal sections are excluded from lockfile generation and validation:

- **Team sections** (default): Validated against lockfile (triggers drift on changes)
- **Personal sections**: Not validated (can change freely)

**Use cases:**

- Personal coding shortcuts and reminders
- Individual workflow preferences
- Local development notes
- Experimental rules for personal projects

For practical workflows, examples, and conceptual background, see [Rule sharing & privacy guide](/docs/01-guides/06-rule-sharing-privacy).

## See also

- **[Commands Reference](/docs/04-reference/cli-reference)** - Complete CLI command documentation
- **[Quickstart Guide](/docs/00-getting-started/00-quickstart)** - Setup and first sync
- **[Drift Detection](/docs/03-concepts/drift-detection)** - Monitoring team alignment
- **[Git Workflows](/docs/03-concepts/git-workflows)** - Git-based rule sharing and vendoring
- **[Onboarding](/docs/04-reference/cli-reference/onboard)** - Developer onboarding checklists
- **[Examples](/docs/04-reference/examples)** - team-repo and vendored-align examples
