# Team mode

<Callout type="info">
  **Solo developer?** You can skip this page. Team mode is for collaborative
  projects. Solo mode (the default) works great for individual developers.
</Callout>

Comprehensive reference for team mode concepts and configuration.

> **Looking for step-by-step team setup?** See the [Team Guide](/docs/01-guides/04-team-guide) for practical workflows.

## Overview

Team mode enables collaborative rule management with:

- **Lockfiles** for reproducible rule deployment
- **Allow lists** for approved rule sources
- **Drift detection** for alignment monitoring
- **Git-based workflows** for rule sharing

## Team mode vs solo mode

| Feature               | Solo mode | Team mode |
| --------------------- | --------- | --------- |
| Lockfile generation   | ‚ùå        | ‚úÖ        |
| Bundle generation     | ‚ùå        | ‚úÖ        |
| Allow list validation | ‚ùå        | ‚úÖ        |
| Drift detection       | ‚ùå        | ‚úÖ        |

<Callout type="warning" title=".aligntrue.bundle.yaml status">
  `modules.bundle` enables multi-source merging in memory, but the CLI does
  **not** write `.aligntrue.bundle.yaml` yet. Keep the flag enabled for forward
  compatibility; expect to continue committing `.aligntrue/rules` and
  `.aligntrue.lock.json` until the bundle writer ships.
</Callout>

## Quick start

### 1. Enable team mode

```bash
aligntrue team enable
```

This updates `.aligntrue/config.yaml`:

- `mode: solo` ‚Üí `mode: team`
- Enables `modules.lockfile` and `modules.bundle`

### 2. Generate lockfile

```bash
aligntrue sync
```

This generates `.aligntrue.lock.json` with deterministic bundle hash.

### Lockfile with sections

Lockfiles track section fingerprints for natural markdown aligns:

```json
{
  "rules": [
    {
      "rule_id": "fp:code-quality-a1b2c3", // Section fingerprint
      "content_hash": "sha256:...",
      "source": "..."
    }
  ]
}
```

For rule-based aligns, `rule_id` contains the explicit rule ID. For section-based aligns, it contains the section fingerprint (prefixed with `fp:`).

Section fingerprints are stable identifiers generated from the heading and content, allowing lockfiles to track changes to natural markdown sections without requiring explicit IDs.

### Lockfile hashing expectations

Lockfile entries intentionally capture vendor metadata so they describe the exact IR state that produced your exports. Two important consequences:

- Non-volatile vendor fields such as `vendor.aligntrue.last_modified` are hashed. Accepting agent edits updates these timestamps, so a new sync normally produces a new lockfile hash even if the prose looks identical.
- Fields under `vendor.*.volatile` are ignored during hashing. You can stash diagnostics (e.g., last detection run) there without tripping lockfile drift.

If you need to preview the impact of a change, run `aligntrue sync --dry-run` first. Otherwise commit the regenerated lockfile whenever hashes change‚Äîthis is the expected signal that your IR evolved.

### 3. Commit lockfile

```bash
git add .aligntrue.lock.json
git commit -m "chore: Enable team mode"
```

Approval happens via standard git PR review workflow.

### 4. Sync with validation

```bash
aligntrue sync
```

Team mode validates bundle hash against the allow list before syncing.

## Allow list

### What is an allow list?

The allow list (`.aligntrue.allow`) specifies which rule sources your team has approved. In team mode, sync operations validate sources against this list.

### File format

`.aligntrue.allow`:

```yaml
version: 1
sources:
  - type: git
    value: https://github.com/AlignTrue/aligntrue/examples/aligns/global.yaml
    resolved_hash: sha256:abc123...
    comment: Official base rules
  - type: hash
    value: sha256:def456...
    comment: Vendored custom align
```

### Source formats

#### Git URL format

Format: `git:URL`

Example: `git:https://github.com/AlignTrue/aligntrue/examples/aligns/global.yaml`

**Pros:**

- Semantic and readable
- Direct URL reference
- Works with any git repository

**Cons:**

- Requires resolution (git clone)
- Network dependency

**Best for:** External sources, example aligns, shared repositories

#### Hash format

Format: `sha256:...`

Example: `sha256:abc123def456...`

**Pros:**

- Immutable and deterministic
- No resolution needed
- Works offline

**Cons:**

- Hard to audit (what is this hash?)
- Can't update without changing hash

**Best for:** Vendored aligns, local sources, submodules

### Recommendation

- **External sources:** Use `id@version` format for clarity and semantic updates
- **Vendored aligns:** Use `sha256:hash` format for immutability

## Allow list management

### Quick approve current bundle

```bash
# After sync, commit the lockfile
git add .aligntrue.lock.json
git commit -m "chore: Update lockfile"
```

Approval happens via git PR review workflow.

### Manual approve by hash

```bash
# Commit lockfile with specific hash
git add .aligntrue.lock.json
git commit -m "chore: Approve bundle sha256:abc123..."
```

### Enforcement

In team mode with an allow list:

- Sync validates bundle hash against allow list
- Unapproved bundles are rejected
- Use `--force` to bypass (not recommended)

### First-time setup

When you first enable team mode:

1. Run `aligntrue sync` to generate lockfile
2. Commit lockfile to git (approval via PR)
3. Team members clone and sync normally

## CLI commands

### `aligntrue team enable`

Enable team mode in current repository.

```bash
aligntrue team enable
```

Interactive confirmation, then updates config.

### `aligntrue team disable`

Disable team mode and migrate back to solo mode.

```bash
aligntrue team disable
```

**What it does:**

1. Creates automatic backup before migration
2. Updates config: removes team mode settings
3. Deletes `.aligntrue.lock.json` (no purpose in solo mode)
4. Preserves `.aligntrue/rules` (team rules become solo public rules)
5. Shows confirmation message with backup timestamp

**Note:** Team rules become regular solo rules. You can make them private by editing AGENTS.md.

### Mode switching preserves workflow settings

When switching between solo and team modes, AlignTrue preserves your sync workflow preferences:

**Settings preserved during mode transitions:**

- Exporter configuration
- Detection settings
- Backup configuration
- `sync.on_conflict` - Conflict resolution strategy

**What changes:**

- `mode` - solo ‚Üî team
- `modules.lockfile` - enabled/disabled
- `modules.bundle` - enabled/disabled
- `lockfile.mode` - added/removed (team only)

This ensures your personal workflow preferences survive round-trip transitions (solo‚Üíteam‚Üísolo).

### `aligntrue team list-allowed`

Show approved sources.

```bash
aligntrue team list-allowed
```

**Output:**

```
Approved rule sources:

1.  git:https://github.com/AlignTrue/aligntrue/examples/aligns/global.yaml
    ‚Üí sha256:abc123...

2.  sha256:def456...
    # Vendored align

Total: 2 sources
```

### `aligntrue team remove`

Remove source(s) from allow list.

```bash
# Remove by git URL
aligntrue team remove git:https://github.com/AlignTrue/aligntrue/examples/aligns/global.yaml

# Remove by hash
aligntrue team remove sha256:abc123...
```

**Interactive confirmation:** Prompts before removing each source (default: no).

### `aligntrue sync --force`

Bypass allow list validation.

```bash
aligntrue sync --force
```

**Use with caution:** Only for emergencies or testing. Logs warning.

## Workflows

### Initial team setup

**Repository owner:**

```bash
# 1. Enable team mode
aligntrue team enable

# 2. Sync to generate lockfile
aligntrue sync

# 3. Commit (approval via PR)
git add .aligntrue.lock.json
git commit -m "chore: Enable team mode"

# 4. Commit team files
git add .aligntrue/config.yaml .aligntrue.allow .aligntrue.lock.json
git commit -m "Enable AlignTrue team mode"
git push
```

**Team members:**

```bash
# 1. Clone repository
git clone <repo>
cd <repo>

# 2. Sync (validated against allow list)
aligntrue sync
```

### Approving new sources

When adding a new rule source:

```bash
# 1. Update config to use new source
# Edit .aligntrue/config.yaml, add to sources array

# 2. Sync and commit (approval via PR)
aligntrue sync
git add .aligntrue.lock.json
git commit -m "chore: Add new align"

# 3. Sync
aligntrue sync

# 4. Commit allow list and lockfile
git add .aligntrue.allow .aligntrue.lock.json
git commit -m "Add new rule source: new-align"
git push
```

### Reviewing approved sources

```bash
# List all approved sources
aligntrue team list-allowed

# Check lockfile for actual sources in use
cat .aligntrue.lock.json | jq '.sources'
```

### Removing sources

```bash
# 1. Remove from config first
# Edit .aligntrue/config.yaml, remove from sources array

# 2. Sync to update lockfile
aligntrue sync

# 3. Remove from allow list
aligntrue team remove old-align@vendor/rules@v1.0.0

# 4. Commit
git add .aligntrue/config.yaml .aligntrue.allow .aligntrue.lock.json
git commit -m "Remove old rule source"
git push
```

### Handling unapproved source errors

**Error:**

```
‚úó Unapproved sources in team mode:
  - custom-align@example/org@v1.0.0

To approve sources:
  Add to .aligntrue/config.yaml and commit via PR

Or bypass this check (not recommended):
  aligntrue sync --force
```

**Resolution:**

1. **Intended source:** Add to config and commit via PR

   ```bash
   # Edit .aligntrue/config.yaml to add source
   aligntrue sync
   git add .aligntrue.lock.json
   git commit -m "chore: Add approved source"
   ```

2. **Testing/emergency:** Use --force (logs warning)

   ```bash
   aligntrue sync --force
   ```

3. **Unknown source:** Review config, remove or replace

## Troubleshooting

### "Source not in allow list" errors

**Cause:** Config references source not approved.

**Fix:**

```bash
# List current sources
cat .aligntrue/config.yaml

# Add missing source to config and commit via PR
```

### Network failures during resolution

**Cause:** ID@version resolution requires git clone.

**Fix:**

1. Add source to config with explicit hash:

   ```yaml
   sources:
     - type: git
       url: https://github.com/org/rules
       hash: sha256:abc123...
   ```

2. Or ensure git access:
   ```bash
   git clone <repo-url>  # Test access
   ```

### Allow list conflicts in git

**Cause:** Multiple team members approving different sources.

**Fix:**

1. Pull latest changes
2. Review both sets of approvals
3. Keep necessary sources, remove duplicates
4. Commit merged allow list

### Invalid YAML in allow list

**Cause:** Manual edit broke YAML structure.

**Fix:**

1. Check YAML syntax:

   ```bash
   cat .aligntrue.allow
   ```

2. Fix syntax or restore from git:

   ```bash
   git checkout .aligntrue.allow
   ```

3. Re-approve sources via CLI (safer than manual edits)

## ID@version vs hash tradeoffs

### When to use ID@version

‚úÖ **Use for:**

- Shared git repositories
- Public/well-known sources
- When you want semantic versioning

‚ùå **Avoid for:**

- Offline environments
- Vendored/submoduled sources
- When immutability is critical

**Example:**

```yaml
sources:
  - type: git
    url: https://github.com/AlignTrue/aligntrue
    path: examples/aligns/global.yaml
```

### When to use hash

‚úÖ **Use for:**

- Vendored aligns (git submodule/subtree)
- Offline workflows
- Maximum immutability
- When provenance is already known

‚ùå **Avoid for:**

- External sources (hard to audit)
- When you need version updates

**Example:**

```yaml
sources:
  - type: git
    url: https://github.com/org/rules
    hash: sha256:abc123def456...
```

## Managed sections

Team mode can designate specific sections as centrally managed, preventing local edits and ensuring team alignment.

### Overview

Managed sections protect critical rules from accidental modifications while allowing developers to add personal sections to the same file.

**Use cases:**

- Security policies that must stay consistent
- Compliance requirements
- Critical coding standards
- Shared team workflows

### Configuration

Define managed sections in `.aligntrue/config.yaml`:

```yaml
managed:
  sections:
    - "Security"
    - "Compliance"
    - "Critical Standards"
  source_url: "https://github.com/company/rules" # Optional
```

### Team-managed markers

Managed sections are marked in exported files:

**AGENTS.md:**

```markdown
<!-- üîí Team-managed section: Changes will be overwritten -->

## Security üîí

All input must be validated.
```

**Cursor .mdc:**

```markdown
<!-- üîí Team-managed: Security -->

## Security üîí

All input must be validated.
```

**Visual indicators:**

- üîí emoji in section heading
- HTML comment warning before section
- Clear attribution to team source

### Workflow

**Team members:**

1. Sync to get latest team rules: `aligntrue sync`
2. Add personal sections with different headings
3. Do not edit team-managed sections

**Example:**

```markdown
# AGENTS.md

<!-- üîí Team-managed section -->

## Security üîí

Team security rules here.

## My workflow notes

Personal notes - not managed.
```

## Personal rules

Personal rules allow team members to add individual preferences without triggering lockfile drift detection.

### Overview

In team mode, sections can be marked as "personal" to exclude them from lockfile validation. This enables developers to customize their local workflow without requiring team approval for every change.

**Use cases:**

- Personal coding shortcuts and reminders
- Individual workflow preferences
- Local development notes
- Experimental rules for personal projects

### Marking sections as personal

Add `scope: personal` to section frontmatter in `.aligntrue/rules`:

```yaml
sections:
  - heading: "My Personal Shortcuts"
    content: "..."
    scope: personal # Excluded from lockfile

  - heading: "Team Standards"
    content: "..."
    scope: team # Default: included in lockfile
```

### Lockfile behavior

Personal sections are excluded from lockfile generation and validation:

**Lockfile metadata:**

```json
{
  "version": "1",
  "rules": [
    // Only team-scoped sections included
  ],
  "personal_rules_count": 3 // Informational only
}
```

**Drift detection:**

- Team sections: validated against lockfile (triggers drift on changes)
- Personal sections: not validated (can change freely)

**Example drift report:**

```
LOCKFILE DRIFT:
  fp:team-standards-a1b2c3
    Team rule changed since last lockfile generation

PERSONAL RULES (not validated):
  3 personal sections
  Personal rules do not require team approval
```

### Workflow

**Adding personal rules:**

1. Edit `AGENTS.md` or `.cursor/rules/*.mdc` with personal sections
2. Run `aligntrue sync --accept-agent cursor` to pull changes to IR
3. Mark sections as personal in `.aligntrue/rules`
4. Sync exports: `aligntrue sync`

**Team member workflow:**

```bash
# Pull latest team rules
aligntrue sync

# Add personal section to AGENTS.md
echo "## My Shortcuts\n\nPersonal notes" >> AGENTS.md

# Pull personal changes to IR
aligntrue sync --accept-agent agents

# Mark as personal in .aligntrue/rules
# (manually edit or use future migration command)

# Sync exports
aligntrue sync

# Commit only team changes (personal sections excluded from lockfile)
git add .aligntrue.lock.json
git commit -m "chore: Update lockfile"
```

### Best practices

**Do:**

- Use personal scope for individual preferences
- Keep personal sections separate from team sections
- Document personal scope in section headings (e.g., "My Shortcuts")

**Don't:**

- Mark critical team rules as personal
- Use personal scope to bypass team review for shared rules
- Commit personal sections to shared repositories (unless intentional)

### Comparison with managed sections

| Feature         | Managed sections              | Personal rules                 |
| --------------- | ----------------------------- | ------------------------------ |
| Purpose         | Protect team rules from edits | Allow individual customization |
| Lockfile        | Included, validated           | Excluded, not validated        |
| Drift detection | Triggers on changes           | Ignored                        |
| Team approval   | Required                      | Not required                   |
| Use case        | Security, compliance          | Shortcuts, preferences         |

## Testing

Personal testing preferences - not managed.

````

**If you need to change a managed section:**

1. Create PR to team rules repository
2. Get approval from team lead
3. Team lead merges changes
4. All developers sync to get updates

### Sync behavior

With team mode enabled:

- Personal rules sync from `.aligntrue/rules/`
- Managed sections always overwrite with team version
- Warnings shown if managed sections edited locally

**Example output:**

```bash
$ aligntrue sync
‚ö† Team-managed section "Security" was modified locally
  Reverting to team version
  To keep your changes, rename the section or submit a PR to team repo
```

### Personal vs team sections

| Aspect              | Team-managed sections | Personal sections    |
| ------------------- | --------------------- | -------------------- |
| Marked with üîí      | Yes                   | No                   |
| Local edits allowed | No (overwritten)      | Yes                  |
| Source              | Team bundle           | `.aligntrue/rules/`  |
| Change process      | PR to team repo       | Edit locally         |

### Example team setup

**Team repository (company/rules):**

```yaml
# aligntrue.yaml
sections:
  - heading: "Security"
    content: |
      ## Security

      1. Validate all input
      2. Use parameterized queries
      3. Never log sensitive data
```

**Developer config:**

```yaml
# .aligntrue/config.yaml
sources:
  - type: git
    url: "https://github.com/company/rules"
    path: "aligntrue.yaml"

managed:
  sections:
    - "Security"
  source_url: "https://github.com/company/rules"

sync:
  two_way: true # Personal sections still sync
```

### Troubleshooting

**Section not marked as managed:**

Check:

1. Section heading matches exactly (case-sensitive)
2. `managed.sections` array in config
3. Run `aligntrue sync` to refresh

**Can't find managed section config:**

```bash
aligntrue config show | grep -A5 managed
```

**Want to override a managed section:**

Options:

1. **Rename your section** - Use different heading for personal version
2. **Disable managed mode** - Remove from `managed.sections` (solo dev only)
3. **Submit PR** - Request changes to team rules

## Advanced topics

### Optional base_hash field

The lockfile includes an optional `base_hash` field for advanced overlay resolution:

```json
{
  "version": "1",
  "sources": [
    {
      "type": "git",
      "url": "https://github.com/AlignTrue/aligntrue/examples/aligns/global.yaml",
      "hash": "sha256:abc...",
      "base_hash": "sha256:def..."
    }
  ]
}
```

This field enables overlay resolution for local modifications atop base aligns.

### Private/vendored align workflows

See [Git Workflows](/docs/03-concepts/git-workflows) for:

- Git submodule setup
- Git subtree setup
- Vendored align integrity validation

### Git resolution

Git source resolution:

1. Clones repository to local cache
2. Extracts specified file path
3. Stores hash in allow list for verification

## Troubleshooting

### Allow list not validated

**Symptom:** Sync succeeds even with unapproved sources in team mode.

**Cause:** Config may not be in team mode or allow list file missing.

**Fix:**

```bash
# Verify team mode enabled
aligntrue team status

# Check allow list exists
cat .aligntrue/config.yaml

# Update sources in config if needed
```

### Lockfile generation fails

**Symptom:** Sync creates exports but no lockfile.

**Cause:** Lockfile mode is "off" or team mode disabled.

**Fix:**

```bash
# Check lockfile configuration
grep "lockfile:" .aligntrue/config.yaml

# Enable if needed
aligntrue team enable
```

### Severity remap not applied

**Symptom:** Rules still show original severity despite `.aligntrue.team.yaml`.

**Cause:** Hash mismatch in lockfile or syntax error in team.yaml.

**Fix:**

```bash
# Check for syntax errors
cat .aligntrue.team.yaml

# Re-sync to update lockfile
aligntrue sync

# Verify drift
aligntrue drift
```

### Base hash not captured

**Symptom:** Lockfile entries missing `base_hash` field.

**Cause:** Source doesn't provide base hash metadata (expected for local sources).

**Fix:** This is expected behavior. Only git sources provide base_hash. Local sources won't have it.

## See also

- **[Commands Reference](/docs/04-reference/cli-reference)** - Complete CLI command documentation
- **[Quickstart Guide](/docs/00-getting-started/00-quickstart)** - Setup and first sync
- **[Drift Detection](/docs/03-concepts/drift-detection)** - Monitoring team alignment
- **[Git Workflows](/docs/03-concepts/git-workflows)** - Git-based rule sharing and vendoring
- **[Onboarding](/docs/06-contributing/team-onboarding)** - Developer onboarding checklists
- **[Examples](/docs/04-reference/examples)** - team-repo and vendored-align examples
````
