---
title: "Drift detection (lockfile)"
description: "Detect and report drift between the lockfile and approved sources, with output formats and review workflows."
---

# Drift detection

<Callout type="info">
  **Solo developer?** You can skip this page. Drift detection is for teams using
  lockfiles and team mode.
</Callout>

Drift detection helps teams monitor alignment between their lockfile and approved rule sources. It identifies when rules have changed upstream, when vendored aligns differ from their sources, or when severity remapping policies have been modified.

## Overview

Drift detection compares your lockfile's rule hashes against:

- **Vendored aligns** - Integrity of git submodule/subtree vendored rules
- **Severity remapping** - Policy changes in `.aligntrue.team.yaml`

**Key benefits:**

- Catch upstream rule changes before they cause issues
- Verify vendored align integrity
- Monitor policy compliance
- CI/CD integration with `--gates` flag

## Drift categories

### Upstream drift

**What it detects:** Rule content changed since last lockfile generation.

**Common causes:**

- Upstream align updated to new version
- Local modifications to rules

**How to fix:**

```bash
# Review the changes
aligntrue drift

# Accept current state
aligntrue sync --force
```

### Vendorized drift

**What it detects:** Vendored align (git submodule/subtree) differs from source or is missing.

**Common causes:**

- Vendored align deleted or moved
- Align updated without re-linking
- Missing markdown rules in vendored path

**How to fix:**

```bash
# Update vendored align
cd vendor/align-name
git pull
cd ../..

# Re-sync
aligntrue sync
```

### Agent file drift

**What it detects:** Manual edits to agent files (`AGENTS.md`, `.cursor/rules/*.mdc`) that haven't been synced back to the IR.

**Common causes:**

- Developer edited agent files directly
- Copy/pasting new rules into agent files

**How to fix:**

```bash
# Overwrite with current IR state:
aligntrue sync
```

**Mechanism:**
Uses content hashing (SHA-256) to detect changes reliably across all platforms. Timestamps are not used.

### Severity remap drift

**What it will detect:** Changes to `.aligntrue.team.yaml` severity remapping rules.

**Common causes:**

- Policy downgrade without rationale
- Remapping rules modified

## Usage

### Basic drift check

```bash
# Show drift (human-readable)
aligntrue drift

# Output:
# Drift detection report
# ======================
#
# Upstream drift (1 items):
#   â€¢ base-global: Lockfile hash differs from allowed version
#     Suggestion: Review and approve via git PR
```

### CI integration

```bash
# Exit non-zero if drift detected
aligntrue drift --gates

# Exit codes:
# 0 = No drift detected
# 2 = Drift detected (only with --gates)
```

### JSON output

```bash
# Machine-readable output
aligntrue drift --json

# Output:
# {
#   "driftDetected": true,
#   "mode": "team",
#   "lockfilePath": ".aligntrue.lock.json",
#   "summary": "2 drift findings across 2 categories",
#   "driftByCategory": {
#     "lockfile": [...],
#     "agent_file": [...]
#   }
# }
```

### SARIF output

```bash
# For GitHub/GitLab CI integration
aligntrue drift --sarif > drift-report.sarif

# Upload to GitHub code scanning
# (GitHub Actions example in CI workflows section)
```

## CI workflows

<Tabs items={["GitHub Actions", "GitLab CI"]}>

<Tabs.Tab>

### GitHub Actions

```yaml
name: Drift Detection

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight
  workflow_dispatch:

jobs:
  drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install -g @aligntrue/cli

      - name: Check for drift
        run: aligntrue drift --sarif > drift.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: drift.sarif
```

</Tabs.Tab>

<Tabs.Tab>

### GitLab CI

```yaml
drift-detection:
  stage: test
  script:
    - npm install -g @aligntrue/cli
    - aligntrue drift --gates
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
```

</Tabs.Tab>

</Tabs>

### Pre-commit hook

```bash
#!/bin/sh
# .git/hooks/pre-commit

# Check for drift before committing lockfile changes
if git diff --cached --name-only | grep -q ".aligntrue.lock.json"; then
  echo "Lockfile changed, checking for drift..."
  aligntrue drift --gates
fi
```

## Troubleshooting

### "Drift detection requires team mode"

**Cause:** Running `aligntrue drift` in solo mode.

**Solution:**

```bash
# Enable team mode
aligntrue team enable

# Or set in config
echo "mode: team" >> .aligntrue/config.yaml
```

### "Lockfile not found"

**Cause:** No lockfile generated yet.

**Solution:**

```bash
# Generate lockfile
aligntrue sync
```

### Resolving drift

**Scenario:** Rules were updated and need approval.

**Solution:** Commit lockfile changes via git PR for team review:

```bash
# After syncing with rule changes
git add .aligntrue.lock.json
git commit -m "chore: Update rules (team approval via PR)"
git push
```

### False positives

**Scenario:** Drift reported but you know rules haven't changed.

**Debugging:**

1. Check lockfile generation date
2. Check for stray edits in `.aligntrue/rules/`
3. Re-sync to update lockfile

**Solution:**

```bash
# Regenerate lockfile
aligntrue sync --force
```

## Configuration

Drift detection uses your existing AlignTrue configuration:

```yaml
# .aligntrue/config.yaml
mode: team # Required for drift detection

# Lockfile settings
modules:
  lockfile: true # Required

lockfile:
  mode: soft # or strict

# Performance settings (optional)
performance:
  max_file_size_kb: 1024
  respect_gitignore: true
```

## Best practices

### Regular monitoring

- Run `aligntrue drift` in CI daily or on schedule
- Use `--gates` flag in PR checks to block on drift
- Review drift reports during team sync meetings

### When to use --gates

**Use `--gates` flag when:**

- Enforcing strict version control
- Blocking PRs with unauthorized changes
- Maintaining compliance requirements

**Don't use `--gates` when:**

- Exploring drift informally
- Learning about upstream changes
- Testing new rule versions

### Handling drift findings

**Upstream drift:**

1. Review changelog for upstream align
2. Test changes in dev environment
3. Approve new version or pin current
4. Update documentation

**Vendorized drift:**

1. Check git submodule/subtree status
2. Update vendored align if appropriate
3. Re-link and re-sync
4. Commit vendored changes

## Related documentation

- [Team mode](/docs/03-concepts/team-mode) - Team collaboration features
- [Git workflows](/docs/03-concepts/git-workflows) - Git sources and vendoring workflows
- [Commands](/docs/04-reference/cli-reference) - All CLI commands reference

## See also

- **Lockfile**: `.aligntrue.lock.json` generation and validation
- **Team mode**: Enabling and configuring team collaboration
