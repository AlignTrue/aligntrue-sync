{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aligntrue.ai/schema/config-v1.schema.json",
  "title": "AlignTrue Config v1",
  "description": "Configuration schema for AlignTrue CLI (solo/team/enterprise modes)",
  "type": "object",
  "required": [],
  "additionalProperties": true,
  "properties": {
    "version": {
      "type": "string",
      "description": "Config version identifier (e.g., '1' or semver '1.0.0')"
    },
    "mode": {
      "type": "string",
      "enum": ["solo", "team", "enterprise"],
      "description": "Operating mode: solo (default, no lockfile), team (lockfile+bundle), enterprise (all features)"
    },
    "modules": {
      "type": "object",
      "description": "Module feature flags (opt-in per module)",
      "additionalProperties": false,
      "properties": {
        "lockfile": {
          "type": "boolean",
          "description": "Enable lockfile generation for reproducibility (auto-enabled in team mode)"
        },
        "bundle": {
          "type": "boolean",
          "description": "Enable bundle generation for multi-source merging (auto-enabled in team mode)"
        },
        "checks": {
          "type": "boolean",
          "description": "Enable machine-checkable rules engine (default: true)"
        },
        "mcp": {
          "type": "boolean",
          "description": "Enable MCP server for editor integration (implemented)"
        }
      }
    },
    "lockfile": {
      "type": "object",
      "description": "Lockfile-specific configuration",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["off", "soft", "strict"],
          "description": "Lockfile validation mode: off (no validation), soft (warn on mismatch), strict (error on mismatch)"
        }
      }
    },
    "git": {
      "type": "object",
      "description": "Git integration settings",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["ignore", "commit", "branch"],
          "description": "Git integration mode: ignore (no tracking), commit (auto-commit), branch (dedicated branch)"
        },
        "per_adapter": {
          "type": "object",
          "description": "Override git mode per exporter adapter",
          "additionalProperties": {
            "type": "string",
            "enum": ["ignore", "commit", "branch"]
          }
        },
        "branch_check_interval": {
          "type": "number",
          "minimum": 0,
          "description": "Interval in seconds to check branches for updates (default: 86400 = 24 hours)"
        },
        "tag_check_interval": {
          "type": "number",
          "minimum": 0,
          "description": "Interval in seconds to check tags for updates (default: 604800 = 7 days)"
        },
        "offline_fallback": {
          "type": "boolean",
          "description": "Use cache if network unavailable (default: true)"
        },
        "auto_gitignore": {
          "type": "string",
          "enum": ["auto", "always", "never"],
          "description": "Automatically manage .gitignore: auto (based on git.mode), always, never (default: auto)"
        }
      }
    },
    "sync": {
      "type": "object",
      "description": "Sync behavior configuration",
      "additionalProperties": false,
      "properties": {
        "auto_pull": {
          "type": "boolean",
          "description": "Automatically pull changes from primary agent on sync (default: true for solo, false for team)"
        },
        "primary_agent": {
          "type": "string",
          "description": "Primary agent to auto-pull from (e.g., 'cursor', 'copilot')"
        },
        "on_conflict": {
          "type": "string",
          "enum": ["prompt", "keep_ir", "accept_agent"],
          "description": "Conflict resolution strategy: prompt (interactive), keep_ir (default), accept_agent (auto-accept)"
        },
        "workflow_mode": {
          "type": "string",
          "enum": ["auto", "ir_source", "native_format"],
          "description": "Editing workflow preference: auto (ask on conflict), ir_source (edit .rules.yaml or AGENTS.md), native_format (edit agent files)"
        },
        "show_diff_on_pull": {
          "type": "boolean",
          "description": "Show diff summary when auto-pull executes (default: true)"
        },
        "two_way": {
          "type": "boolean",
          "description": "DEPRECATED: Use 'edit_source' instead. Enable two-way sync: detect edited agent files and merge back to IR (default: true)",
          "deprecated": true
        },
        "edit_source": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single file pattern or mode for accepting edits"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Multiple file patterns for accepting edits"
            }
          ],
          "description": "Which file(s) accept edits: '.rules.yaml' (IR only), 'AGENTS.md' (single file), '.cursor/rules/*.mdc' (glob pattern), 'any_agent_file' (all agents), or array of patterns"
        },
        "backup_on_overwrite": {
          "type": "string",
          "enum": ["auto", "always", "never"],
          "description": "DEPRECATED: Inline .bak files are no longer supported",
          "deprecated": true
        },
        "backup_extension": {
          "type": "string",
          "description": "DEPRECATED: Inline .bak files are no longer supported",
          "deprecated": true
        },
        "scope_prefixing": {
          "type": "string",
          "enum": ["off", "auto", "always"],
          "description": "Add scope prefixes to section headings in single-file exports: off (no prefixes), auto (prefix when multiple scopes detected), always (always prefix). Default: off"
        },
        "watch_enabled": {
          "type": "boolean",
          "description": "Enable watch mode for auto-sync on file changes (default: false)"
        },
        "watch_debounce": {
          "type": "number",
          "minimum": 100,
          "maximum": 10000,
          "description": "Debounce delay in milliseconds for watch mode (default: 500)"
        },
        "watch_files": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "File patterns to watch for changes (default: auto-detect from exporters)"
        },
        "source_files": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single file pattern for source rules"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Multiple file patterns for source rules"
            }
          ],
          "description": "Source file patterns for rules (default: 'AGENTS.md'). Examples: 'AGENTS.md', '*.md', ['architecture.md', 'security.md'], '.aligntrue/rules/*.md'"
        },
        "source_order": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Custom ordering of source files by basename (default: alphabetical). Example: ['architecture.md', 'security.md', 'coding.md']"
        },
        "source_markers": {
          "type": "string",
          "enum": ["auto", "always", "never"],
          "description": "Control source file markers in concatenated outputs. auto: show only with multiple sources (default), always: always show, never: never show"
        },
        "auto_manage_ignore_files": {
          "oneOf": [
            {
              "type": "boolean"
            },
            {
              "type": "string",
              "enum": ["prompt"]
            }
          ],
          "description": "Automatically manage agent ignore files to prevent duplicate context. true: always manage, false: never manage, prompt: ask user (default: prompt)"
        },
        "ignore_file_priority": {
          "type": "string",
          "enum": ["native", "custom"],
          "description": "Priority for format selection when multiple formats are available. native: use agent's native format (default), custom: use custom_format_priority"
        },
        "custom_format_priority": {
          "type": "object",
          "description": "Override native format priority per agent (e.g., {cursor: 'agents'} to prefer AGENTS.md over .mdc)",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "managed": {
      "type": "object",
      "description": "Team-managed content protection (team mode)",
      "additionalProperties": false,
      "properties": {
        "files": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Full file paths to protect from direct edits"
        },
        "sections": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Section headings to protect from direct edits"
        },
        "source_url": {
          "type": "string",
          "format": "uri",
          "description": "Team repository URL for reference"
        }
      }
    },
    "sources": {
      "type": "array",
      "description": "Source providers for rules (local files, catalog, git repos, URLs)",
      "items": {
        "type": "object",
        "required": ["type"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "enum": ["local", "catalog", "git", "url"],
            "description": "Source provider type"
          },
          "path": {
            "type": "string",
            "description": "Local file path (required for type: local)"
          },
          "url": {
            "type": "string",
            "description": "Remote URL (required for type: git or url)"
          },
          "ref": {
            "type": "string",
            "description": "Git branch, tag, or commit SHA (for type: git, defaults to 'main')"
          },
          "check_interval": {
            "type": "number",
            "minimum": 0,
            "description": "Override global check interval for this git source (seconds). Branches default to 24h, tags to 7 days, commits never check."
          },
          "id": {
            "type": "string",
            "description": "Catalog pack ID (required for type: catalog)"
          },
          "version": {
            "type": "string",
            "description": "Version constraint for catalog packs (e.g., '^1.0.0')"
          }
        }
      }
    },
    "exporters": {
      "type": "array",
      "description": "List of exporter adapters to generate (e.g., 'cursor', 'agents')",
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "scopes": {
      "type": "array",
      "description": "Hierarchical scopes for monorepo path-based rule application",
      "items": {
        "type": "object",
        "required": ["path"],
        "additionalProperties": false,
        "properties": {
          "path": {
            "type": "string",
            "description": "Relative path from workspace root (e.g., 'packages/frontend')"
          },
          "include": {
            "type": "array",
            "description": "Glob patterns to include within this scope",
            "items": {
              "type": "string"
            }
          },
          "exclude": {
            "type": "array",
            "description": "Glob patterns to exclude from this scope",
            "items": {
              "type": "string"
            }
          },
          "rulesets": {
            "type": "array",
            "description": "Rule IDs or pack references to apply in this scope",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "merge": {
      "type": "object",
      "description": "Merge strategy configuration for multi-source rules",
      "additionalProperties": false,
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["deep"],
          "description": "Merge strategy: deep (property-level merge by rule ID)"
        },
        "order": {
          "type": "array",
          "description": "Merge order (precedence): root < path < local",
          "items": {
            "type": "string",
            "enum": ["root", "path", "local"]
          },
          "uniqueItems": true
        }
      }
    },
    "performance": {
      "type": "object",
      "description": "Performance guardrails and resource limits",
      "additionalProperties": false,
      "properties": {
        "max_file_size_mb": {
          "type": "number",
          "minimum": 1,
          "maximum": 1000,
          "description": "Maximum file size in MB for source files (default: 10MB)"
        },
        "max_directory_depth": {
          "type": "number",
          "minimum": 1,
          "maximum": 50,
          "description": "Maximum directory depth for scanning (default: 10 levels)"
        },
        "ignore_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional ignore patterns beyond .gitignore (glob format)"
        }
      }
    },
    "export": {
      "type": "object",
      "description": "Export behavior configuration for mode hints and token caps",
      "additionalProperties": true,
      "properties": {
        "mode_hints": {
          "type": "object",
          "description": "Control how execution mode metadata is exported to non-Cursor formats",
          "additionalProperties": false,
          "properties": {
            "default": {
              "type": "string",
              "enum": ["off", "metadata_only", "hints", "native"],
              "description": "Default mode hints behavior: off (no markers), metadata_only (JSON markers only), hints (markers + visible intent), native (exporter-specific)"
            },
            "overrides": {
              "type": "object",
              "description": "Per-exporter overrides for mode hints behavior",
              "additionalProperties": {
                "type": "string",
                "enum": ["off", "metadata_only", "hints", "native"]
              }
            }
          }
        },
        "max_hint_blocks": {
          "type": "number",
          "minimum": 1,
          "description": "Maximum number of rules to include mode hints for (default: 20)"
        },
        "max_hint_tokens": {
          "type": "number",
          "minimum": 100,
          "description": "Maximum token budget for mode hints across all rules (default: 1600)"
        }
      }
    },
    "backup": {
      "type": "object",
      "description": "Backup and restore configuration. Backups are mandatory before destructive operations.",
      "additionalProperties": false,
      "properties": {
        "keep_count": {
          "type": "number",
          "description": "Number of backups to keep (older backups auto-deleted, default: 20)",
          "minimum": 10,
          "maximum": 100
        }
      }
    },
    "detection": {
      "type": "object",
      "description": "Agent detection configuration for automatic discovery during sync",
      "additionalProperties": false,
      "properties": {
        "auto_enable": {
          "type": "boolean",
          "description": "Auto-enable detected agents without prompting (default: false)"
        },
        "ignored_agents": {
          "type": "array",
          "description": "Agents to never prompt about during detection",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "overlays": {
      "type": "object",
      "description": "Overlay configuration for declarative customization of upstream rules (Overlays system)",
      "additionalProperties": false,
      "properties": {
        "overrides": {
          "type": "array",
          "description": "List of overlay definitions to apply to upstream rules",
          "items": {
            "type": "object",
            "required": ["selector"],
            "additionalProperties": false,
            "properties": {
              "selector": {
                "type": "string",
                "description": "Deterministic selector targeting exactly one rule (e.g., 'rule[id=...]')",
                "minLength": 1
              },
              "set": {
                "type": "object",
                "description": "Key-value pairs to set (supports nested paths with dot notation)",
                "additionalProperties": true
              },
              "remove": {
                "type": "array",
                "description": "List of keys to remove (supports nested paths with dot notation)",
                "items": {
                  "type": "string",
                  "minLength": 1
                }
              }
            }
          }
        },
        "limits": {
          "type": "object",
          "description": "Size limits for overlay configuration",
          "additionalProperties": false,
          "properties": {
            "max_overrides": {
              "type": "number",
              "minimum": 1,
              "maximum": 200,
              "description": "Maximum number of overrides allowed (default: 50)"
            },
            "max_operations_per_override": {
              "type": "number",
              "minimum": 1,
              "maximum": 100,
              "description": "Maximum combined set+remove operations per override (default: 20)"
            }
          }
        }
      }
    },
    "plugs": {
      "type": "object",
      "description": "Plug fills for template slots in rules",
      "additionalProperties": false,
      "properties": {
        "fills": {
          "type": "object",
          "description": "Slot fills (key: slot name, value: fill value)",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "approval": {
      "type": "object",
      "description": "Approval workflow configuration for team mode",
      "additionalProperties": false,
      "properties": {
        "internal": {
          "type": "string",
          "enum": ["pr_approval", "allowlist"],
          "description": "Approval mode for internal team repository changes"
        },
        "external": {
          "type": "string",
          "enum": ["pr_approval", "allowlist"],
          "description": "Approval mode for external dependency sources"
        }
      }
    },
    "managed": {
      "type": "object",
      "description": "Team-managed sections configuration",
      "additionalProperties": false,
      "properties": {
        "sections": {
          "type": "array",
          "description": "List of section headings that are team-managed",
          "items": {
            "type": "string"
          }
        },
        "source_url": {
          "type": "string",
          "description": "Optional URL to the source repository for team-managed sections"
        }
      }
    }
  }
}
