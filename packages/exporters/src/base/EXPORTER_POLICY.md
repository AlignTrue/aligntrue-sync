# Exporter Policy

This document defines the consistent policies that all AlignTrue exporters must follow.

## Core Principles

### 1. No "Generated by" Headers

**Rule:** Exported files MUST NOT contain "Generated by AlignTrue" headers or similar provenance markers.

**Rationale:** Exported files are intended to be edit sources. Adding "Generated by" headers makes them feel read-only and confuses users about which files they should edit.

**Example - Bad:**

```markdown
# AGENTS.md

**Version:** v1
**Generated by:** AlignTrue

This file contains rules and guidance for AI coding agents.

## Your Rule Here

...
```

**Example - Good:**

```markdown
## Your Rule Here

...
```

### 2. No Content Hash in Exported Files

**Rule:** Content hashes MUST NOT appear in exported files (no footers, no comments).

**Rationale:** Content hashes are for verification and drift detection, not for end users. They belong in:

- CLI output (displayed after sync)
- Lockfiles (`.aligntrue.lock.json`)
- `ExportResult.contentHash` (for programmatic use)

**Example - Bad:**

```markdown
## Your Rule

Content here

---

**Content Hash:** sha256:abc123...
```

**Example - Good:**

```markdown
## Your Rule

Content here
```

The content hash is returned in `ExportResult` and displayed by the CLI, not embedded in the file.

### 3. Source Markers are Optional

**Rule:** Source markers (`<!-- aligntrue:source file.md -->`) are controlled by the `sync.source_markers` config option.

**Options:**

- `"auto"` (default): Show markers only when multiple source files are configured
- `"always"`: Always show markers
- `"never"`: Never show markers

**Implementation:** Use `this.generateSourceMarker(section, config)` from `ExporterBase`.

### 4. Agent-Specific Format Requirements

**Rule:** Agent-specific format requirements (YAML frontmatter, JSON structure, etc.) belong in individual exporters, NOT in AlignTrue metadata.

**Examples:**

- ✅ Cursor YAML frontmatter: Required by Cursor format, belongs in `cursor/index.ts`
- ✅ MCP JSON structure: Required by MCP spec, belongs in `*-mcp/index.ts`
- ❌ "Generated by AlignTrue" header: AlignTrue metadata, doesn't belong in any exporter

### 5. Overlay Effects in IR vs Exports

**Rule:** Overlays modify the canonical IR (`.aligntrue/.rules.yaml`) and affect behavior, but metadata changes (severity, check options, etc.) may not be visible in all export formats.

**Rationale:**

- Overlays operate on the IR and are always applied before export
- Changes to metadata like severity affect linting/checking behavior even if not rendered in markdown
- Markdown formats prioritize readability and don't include machine metadata by design
- Users can verify overlay application via:
  - `aligntrue override status` - see active overlays
  - `aligntrue override diff` - see what changed
  - `.aligntrue/.rules.yaml` - inspect the canonical IR directly
  - CLI output during sync - warnings show overlay application

**Example:**

```yaml
# Config: Set "Global principles" severity to error via overlay
overlays:
  overrides:
    - selector: "sections[heading=Global principles]"
      set:
        severity: "error"
```

After sync:

- ✅ IR has `severity: "error"` in `.aligntrue/.rules.yaml`
- ✅ Behavior changes (linting treats this as error)
- ✅ `aligntrue override status` shows the override is active
- ⚠️ AGENTS.md still shows "## Global principles" (no severity indicator)

This is working as designed. To verify overlays are applied, use the diagnostic commands above.

### 6. All Exporters are Equal

**Rule:** No exporter is "privileged" or "the default". AGENTS.md, Cursor, Claude, etc. are all equal outputs from the canonical IR.

**Rationale:** Treating one exporter as special leads to:

- Confusing UX (which file is "the real one"?)
- Inconsistent behavior across exporters
- Hard-coded assumptions in config defaults

**Implementation:**

- Config defaults derive from enabled exporters, no hard-coded fallbacks
- Init creates starter files based on enabled exporters
- Documentation treats all exporters equally

## Canonical Source Architecture

AlignTrue follows an IR-first architecture where `.aligntrue/.rules.yaml` is ALWAYS the canonical source of truth.

```
Edit Sources (controlled by edit_source config)
  ↓ [two-way sync merges edits]
IR (.aligntrue/.rules.yaml) ← ALWAYS CANONICAL
  ↓ [export via all enabled exporters]
Agent Files (AGENTS.md, .mdc, MCP configs, etc.) ← ALL EQUAL OUTPUTS
```

### Key Concepts

**IR (Intermediate Representation):**

- `.aligntrue/.rules.yaml` is the single source of truth
- Auto-generated from edit sources
- Users should NOT edit this file directly
- All operations work on IR, then export to agents

**edit_source:**

- Controls which files accept edits and sync TO canonical IR
- Options: `".rules.yaml"` (IR-only), `"AGENTS.md"`, `".cursor/rules/*.mdc"`, `"any_agent_file"`, or array
- This is about INPUT GATES to IR, not about what's canonical
- Multiple edit sources = multiple input gates to the same canonical IR

**Exporters:**

- All exporters are equal outputs FROM canonical IR
- No exporter is more "canonical" than others
- Each exporter writes its agent-specific format
- Content hash and fidelity notes returned in `ExportResult`, not embedded in files

### Common Misconceptions

❌ **Wrong:** "AGENTS.md is the canonical format"
✅ **Right:** "IR is canonical. AGENTS.md is one of many equal outputs."

❌ **Wrong:** "edit_source defines the canonical source"
✅ **Right:** "edit_source defines input gates to the canonical IR"

❌ **Wrong:** "If I have multiple edit sources, I have multiple canonical sources"
✅ **Right:** "Multiple edit sources merge into one canonical IR"

## Implementation Checklist

When creating or updating an exporter:

- [ ] No "Generated by AlignTrue" headers
- [ ] No content hash in exported files
- [ ] Return `contentHash` in `ExportResult`
- [ ] Use `this.generateSourceMarker()` for optional source markers
- [ ] Use `this.computeSectionFidelityNotes()` for fidelity tracking
- [ ] Return fidelity notes in `ExportResult`, not in files
- [ ] Extend `ExporterBase` for common functionality
- [ ] Document agent-specific format requirements in exporter code
- [ ] Add tests verifying clean output (no AlignTrue metadata)

## Testing

Exporters should have tests verifying:

1. **No headers:** Output doesn't contain "Generated by AlignTrue"
2. **No footers:** Output doesn't contain content hash
3. **Content hash returned:** `ExportResult.contentHash` is present and valid SHA-256
4. **Fidelity notes returned:** `ExportResult.fidelityNotes` contains expected notes
5. **Clean output:** Files are editable markdown/JSON without AlignTrue metadata

## Related Documentation

- [Architecture](../../../apps/docs/content/08-development/architecture.md)
- [Sync Behavior](../../../apps/docs/content/03-concepts/sync-behavior.md)
- [Vendor Bags](../../../apps/docs/content/04-reference/vendor-bags.mdx)
