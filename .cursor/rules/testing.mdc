---
description: Testing decision framework and quality guidelines
---

# Testing decision framework

> Core principle: Tests must catch real bugs and enforce contracts, not add cruft.

Use this when adding, editing, or deleting tests.

---

## Scope

General testing guidance lives here. Sync CLI–specific practices (temp dirs, safety guards, CLI layering, and mocks) now live in `sync_testing.md`.

---

## Data flow and what to test

### Authoritative flow

```
Source: .aligntrue/rules/*.md (user-editable, canonical)
  → IR: in-memory representation (internal, never written to disk)
  → Agent exports: .cursor/*.mdc, AGENTS.md, etc (read-only, generated)
```

### Rules

- Test through public surfaces and exports
- Do not assert internal IR layout unless it is a documented contract
- Agent files are read-only exports; `.aligntrue/rules/*.md` is the source of truth
- Sync overwriting agent files is expected behavior

---

## 5 question test filter

Apply in order:

1. **Has this broken in CI or real usage?**  
   Yes → write a regression test.  
   No → go to 2.

2. **Does it assert a clear boundary or contract?**  
   Yes → keep or add as contract test.  
   No → go to 3.

3. **Does it duplicate coverage?**  
   Yes → delete or merge.  
   No → go to 4.

4. **Does it test implementation details?**  
   Yes → rewrite against observable behavior or delete.  
   No → go to 5.

5. **Is it just for coverage percentage?**  
   Yes → delete.  
   No → keep.

### Golden rule

If deleting the test does not measurably increase risk of real regressions, delete it.

---

## What to keep

1. **Integration tests**
   - Real workflow, temp dirs, no internal mocks

2. **Contract tests**
   - Public APIs
   - Schema behavior
   - Deterministic outputs

3. **Smoke tests**
   - Fast checks for each command

4. **Critical regression tests**
   - One small test per real bug

5. **Performance guards**
   - Loose thresholds to catch major regressions

---

## What to avoid or delete

### Delete

- Import only tests
- Coverage shims
- Pure implementation detail tests
- Duplicates of stronger integration or contract tests
- Tests that rely on heavy internal mocking

### Be cautious with

- **Parameterized tests:**
  - Cap at 10 cases
  - Only when they clarify a real contract
- **Edge cases:**
  - Add only for realistic or observed issues

---

## Test organization

### Structure per package

Each package maintains its own `tests/` directory with subfolders that align with the package's surface area. For example, `packages/cli/tests/` currently looks like:

```
packages/cli/tests/
  check-empty-yaml.test.ts  # YAML validation tests
  commands/                 # CLI command smoke and unit tests
  comprehensive/            # Charter layers and command coverage helpers
  COVERAGE.md               # Test coverage documentation
  drift.test.ts             # Drift detection tests
  e2e/                      # End-to-end workflow tests
    sync-workflow.test.ts
  fixtures/                 # Static files consumed by tests
  helpers/                  # Reusable fixtures and utilities
  integration/              # Real workflows and git-backed scenarios
  scripts/                  # Shell helpers for local runs
  TESTING.md                # Testing documentation
  tmp/                      # Temporary test outputs (gitignored)
  unit/                     # Focused parsing/unit tests
  utils/                    # Supporting utilities and their tests
  version-sync.test.ts      # Version sync tests
```

Other packages follow the same principle (`packages/core/tests/`, `packages/exporters/tests/`, `packages/schema/tests/`, etc.), so new packages should adopt a similar layout that reflects their needs.

Per package, mirror `src/` paths when it keeps tests close to the code they exercise.

---

## Temporary file rules (critical)

All AI or test-generated artifacts in repo must use the `temp-` prefix.

### Allowed

- `temp-test-output.md`
- `temp-bundle.yaml`
- `temp-config.yaml`
- `temp-test-project/`

### Forbidden in repo root or packages

- `test_*.md`, `test-*.yaml`
- `audit*.html`
- `*_config.yaml` without `temp-`
- Generic `audit.*` or `report.*` outside `artifacts/`

### Testing artifacts handled automatically

- Test directories (e.g., `/tmp/aligntrue-*`) are cleaned automatically: keep the last 3 runs or directories newer than 24 hours.
- Package tarballs in `packages/cli/aligntrue-cli-*.tgz` are removed after Layer 1 runs.
- Cleanup executes before and after comprehensive test suites.
- Cleanup script for manual or bulk cleanup:
  ```bash
  pnpm cleanup:temps       # Delete all orphaned test directories
  pnpm cleanup:temps:dry   # Preview what would be deleted (with sizes)
  ```
- Direct manual cleanup (if script unavailable):
  ```bash
  rm -rf /tmp/aligntrue-* /tmp/test-* /tmp/ruler-* /tmp/solo-test* /tmp/team-*
  find packages/cli -name "aligntrue-cli-*.tgz" -exec rm {} \;
  ```

### Permanent names only in

- `examples/`
- `artifacts/`
- `docs/`

### Optional scratch

```
.ai-scratch/
  temp-*.*
```

---

## Local workflow

### Pre commit

- Format and lint staged files
- Fast

### Pre push

- Typecheck
- Tests
- Build (where configured)

Bypass only when hooks are broken, not to skip validation.

## AI testing constraints (critical)

When AI agents perform CLI testing:

### AI must always

- Create isolated `/tmp/aligntrue-test-{timestamp}` directories before running commands
- Change into that directory before invoking the CLI
- Use the absolute CLI binary path: `/path/to/workspace/packages/cli/dist/index.js`
- Set `TZ=UTC` and `NODE_ENV=test`
- Capture stdout, stderr, exit codes, and execution time
- Record findings with severity (P0-P3)
- Clean up the test environment once done

### AI must never

- Modify source files outside the hermetic test directory
- Attempt to fix or implement code changes
- Run CLI commands from the workspace root
- Use `pnpm link --global` (fails with workspace:\* refs)
- Leave artifacts in the workspace (temp dirs only)

### Cleanup after exploratory testing

After any exploratory or manual testing session, AI agents must:

1. **Clean up test directories** created during the session:

   ```bash
   rm -rf /tmp/aligntrue-*  # Remove all AlignTrue test dirs
   rm -rf /tmp/test-*       # Remove common test dirs
   ```

2. **Or use the cleanup script**:

   ```bash
   pnpm cleanup:temps       # Delete all orphaned test directories
   pnpm cleanup:temps:dry   # Preview what would be deleted (verbose)
   ```

3. **Verify cleanup** before ending the session:
   ```bash
   ls /tmp | grep -E '^(aligntrue-|test-|ruler-|solo-test|team-)'
   # Should return empty or only very recent directories
   ```

Automated tests clean up via `afterEach` hooks, but interrupted tests and manual sessions often leave orphans. The cleanup script matches these patterns:

- `aligntrue-*` (all test/backup/perf directories)
- `test-*` (exploratory testing)
- `ruler-*`, `solo-test*`, `team-*` (specific test types)
- `exploratory-*`, `split-test*` (manual testing)

### Safety verification

Structured tests now assert:

- Current directory is under `/tmp/`
- TEST_WORKSPACE env var points to the temp directory
- ALIGNTRUE_CLI env var targets the built CLI
- LOG_FILE env var is set for capturing logs

---

## Handling core format or path changes

When changing core formats or paths:

1. **Search affected tests:**

```bash
grep -r "old-path-or-pattern" packages/*/tests/
```

2. **Update:**
   - File paths
   - Expectations
   - Config references

3. **Run targeted and full suites:**

```bash
pnpm --filter @aligntrue/cli test
pnpm test
```

Same PR must update tests. No "fix tests later."

---

## Test coverage strategy

Design a tight red green path covering:

- **Determinism:** fixed seeds, stable sort, byte identical exports where relevant
- **Boundaries:** missing files, invalid schema, corrupt data, wrong types
- **Integration:** config loading, bundling, exporters, MCP server, CLI wiring
- **Performance sanity:** fast unit tests by default, heavy paths behind marks

---

## TDD workflow

Use TDD for new deterministic features.

1. Write contract tests first
2. Keep fixtures minimal and local
3. Use temp dirs and helpers
4. Implement only what tests require
5. Run with `TZ=UTC` for everything

### Standard

```bash
TZ=UTC pnpm test --silent
TZ=UTC pnpm --filter @aligntrue/cli vitest run <file> -t "<name>"
```

---

## Determinism checklist (for tests and code)

- `TZ=UTC` for CI
- No raw `Date.now()` or `Math.random()` in deterministic paths
- Stable sort for set like arrays
- Newlines normalized to `\n`
- Use shared canonicalization helpers where applicable

---

## CI quality gates

CI should enforce:

- Lint clean
- `tsc --noEmit` clean
- Tests green
- No lingering `test.skip` or `test.todo` for shipped features

---

## Related rules

- `debugging.md` for systematic debugging
- `implementation_specs.md` for determinism rules and IR data flow
- `security_linting_policy.md` for security linting policy
