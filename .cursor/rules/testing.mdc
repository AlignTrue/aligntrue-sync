---
description: Testing decision framework and quality guidelines
alwaysApply: false
---

# Testing decision framework

> Core principle: Tests must catch real bugs and enforce contracts, not add cruft.

Use this when adding, editing, or deleting tests.

---

## External testing requirement (critical)

**⚠️ NEVER TEST IN WORKSPACE ROOT ⚠️**

**All CLI testing must happen outside the workspace root and from isolated `/tmp/` directories.**

### Why

- Detecting existing `.aligntrue/` can corrupt or halt tests
- Running from root risks modifying the user's configuration
- External directories force real-user workflows and keep git clean

### Where to test

```bash
# ✅ CORRECT: isolate every run in /tmp/
cd /tmp
TEST_DIR="aligntrue-test-$(date +%s)"
mkdir "$TEST_DIR" && cd "$TEST_DIR"
# NOW you're in a clean test directory, safe to run CLI commands

# Use absolute path to CLI binary (never pnpm link --global)
/path/to/workspace/packages/cli/dist/index.js init --yes

# ❌ WRONG: running from workspace root triggers safety guards and risks corruption
cd /path/to/workspace
aligntrue init  # ❌ this will detect existing .aligntrue/ and fail or corrupt
```

### Safety guards (automatic)

All structured CLI testing runs include automatic safety checks that verify:

- current directory is under `/tmp/`
- TEST_WORKSPACE env var points to the isolated directory
- ALIGNTRUE_CLI env var targets the built binary
- LOG_FILE env var is set for outputs

When safety checks fail, commands exit with a clear error before touching the workspace.

### Manual test scripts

- Keep them in separate repos or temp directories
- Always use `/tmp/` paths in documentation
- Do not commit manual scripts to the repo
- Reference patterns in `.internal_docs/external-cli-testing.md`

### Integration tests

**Location:** `packages/*/tests/integration/`

**Rules:**

- Use `mkdtemp` from `os.tmpdir()` or create `/tmp/` fixtures
- Clean up in `afterEach` or `finally`
- No artifacts left in repo dirs
- Never run integration suites from the workspace root; always operate inside temp dirs
- Prefer absolute CLI binary paths instead of `pnpm link --global`

---

## Hybrid testing strategy (CLI)

AlignTrue CLI uses a mix of integration, smoke, and contract tests.

### Integration tests

- Real filesystem via temp dirs
- Real `@aligntrue/*` imports
- Verify actual outputs and side effects
- Target: 80%+ coverage for core commands

**Examples:**

- `packages/cli/tests/integration/init-command.test.ts`
- `packages/cli/tests/integration/sync-command.test.ts`
- `packages/core/tests/`

### Smoke tests

- Fast
- 3 to 5 assertions per command
- Check `--help`, argument parsing, basic wiring
- Minimal mocking

**Examples:**

- `packages/cli/tests/commands/sync.test.ts`
- `packages/cli/tests/commands/override-add.test.ts`

### Contract tests

- Public APIs, schema, exporters, core invariants
- Stable over refactors

**Examples:**

- `packages/schema/tests/canonicalize.test.ts`
- `packages/exporters/tests/cursor.test.ts`
- `packages/core/tests/sync/`

---

## Never mock internal packages (critical)

Do not mock `@aligntrue/*` in our tests.

### Allowed mocks

- External services
- `process.exit`
- Time or randomness for determinism
- UI prompts

### Delete tests that

- Mock `@aligntrue/core`, `@aligntrue/schema`, etc
- Duplicate integration coverage
- Only assert calls on mocks

If removing the test would not increase real bug risk, remove it.

---

## Data flow and what to test

### Authoritative flow

```
User files (AGENTS.md, .cursor/*.mdc, etc)
  → IR: .aligntrue/rules (internal, generated)
  → Agent exports: .cursor/*.mdc and others
```

### Rules

- Test through public surfaces and exports
- Do not assert internal IR layout unless it is a documented contract
- Accept that agent files are exports, not primary sources
- Sync overwriting agent files is expected unless `--accept-agent` is involved

---

## 5 question test filter

Apply in order:

1. **Has this broken in CI or real usage?**  
   Yes → write a regression test.  
   No → go to 2.

2. **Does it assert a clear boundary or contract?**  
   Yes → keep or add as contract test.  
   No → go to 3.

3. **Does it duplicate coverage?**  
   Yes → delete or merge.  
   No → go to 4.

4. **Does it test implementation details?**  
   Yes → rewrite against observable behavior or delete.  
   No → go to 5.

5. **Is it just for coverage percentage?**  
   Yes → delete.  
   No → keep.

### Golden rule

If deleting the test does not measurably increase risk of real regressions, delete it.

---

## What to keep

1. **Integration tests**
   - Real workflow, temp dirs, no internal mocks

2. **Contract tests**
   - Public APIs
   - Schema behavior
   - Deterministic outputs

3. **Smoke tests**
   - Fast checks for each command

4. **Critical regression tests**
   - One small test per real bug

5. **Performance guards**
   - Loose thresholds to catch major regressions

---

## What to avoid or delete

### Delete

- Import only tests
- Coverage shims
- Pure implementation detail tests
- Duplicates of stronger integration or contract tests
- Tests that rely on heavy internal mocking

### Be cautious with

- **Parameterized tests:**
  - Cap at 10 cases
  - Only when they clarify a real contract
- **Edge cases:**
  - Add only for realistic or observed issues

---

## Test organization

### Structure per package

Each package maintains its own `tests/` directory with subfolders that align with the package's surface area. For example, `packages/cli/tests/` currently looks like:

```
packages/cli/tests/
  commands/           # CLI command smoke and unit tests
  comprehensive/      # Charter layers and command coverage helpers
  integration/        # Real workflows and git-backed scenarios
  helpers/            # Reusable fixtures and utilities
  fixtures/           # Static files consumed by tests
  scripts/            # Shell helpers for local runs
  unit/               # Focused parsing/unit tests
  utils/              # Supporting utilities and their tests
  drift.test.ts
  workflow-detection.test.ts
  version.test.ts
```

Other packages follow the same principle (`packages/core/tests/`, `packages/exporters/tests/`, `packages/schema/tests/`, etc.), so new packages should adopt a similar layout that reflects their needs.

Per package, mirror `src/` paths when it keeps tests close to the code they exercise.

---

## Temporary file rules (critical)

All AI or test-generated artifacts in repo must use the `temp-` prefix.

### Allowed

- `temp-test-output.md`
- `temp-bundle.yaml`
- `temp-config.yaml`
- `temp-test-project/`

### Forbidden in repo root or packages

- `test_*.md`, `test-*.yaml`
- `audit*.html`
- `*_config.yaml` without `temp-`
- Generic `audit.*` or `report.*` outside `artifacts/`

### Testing artifacts handled automatically

- Test directories (e.g., `/tmp/aligntrue-*`) are cleaned automatically: keep the last 3 runs or directories newer than 24 hours.
- Package tarballs in `packages/cli/aligntrue-cli-*.tgz` are removed after Layer 1 runs.
- Cleanup executes before and after comprehensive test suites.
- Cleanup script for manual or bulk cleanup:
  ```bash
  pnpm cleanup:temps       # Delete all orphaned test directories
  pnpm cleanup:temps:dry   # Preview what would be deleted (with sizes)
  ```
- Direct manual cleanup (if script unavailable):
  ```bash
  rm -rf /tmp/aligntrue-* /tmp/test-* /tmp/ruler-* /tmp/solo-test* /tmp/team-*
  find packages/cli -name "aligntrue-cli-*.tgz" -exec rm {} \;
  ```

### Permanent names only in

- `examples/`
- `artifacts/`
- `docs/`

### Optional scratch

```
.ai-scratch/
  temp-*.*
```

---

## Local workflow

### Pre commit

- Format and lint staged files
- Fast

### Pre push

- Typecheck
- Tests
- Build (where configured)

Bypass only when hooks are broken, not to skip validation.

## AI testing constraints (critical)

When AI agents perform CLI testing:

### AI must always

- Create isolated `/tmp/aligntrue-test-{timestamp}` directories before running commands
- Change into that directory before invoking the CLI
- Use the absolute CLI binary path: `/path/to/workspace/packages/cli/dist/index.js`
- Set `TZ=UTC` and `NODE_ENV=test`
- Capture stdout, stderr, exit codes, and execution time
- Record findings with severity (P0-P3)
- Clean up the test environment once done

### AI must never

- Modify source files outside the hermetic test directory
- Attempt to fix or implement code changes
- Run CLI commands from the workspace root
- Use `pnpm link --global` (fails with workspace:\* refs)
- Leave artifacts in the workspace (temp dirs only)

### Cleanup after exploratory testing

After any exploratory or manual testing session, AI agents must:

1. **Clean up test directories** created during the session:

   ```bash
   rm -rf /tmp/aligntrue-*  # Remove all AlignTrue test dirs
   rm -rf /tmp/test-*       # Remove common test dirs
   ```

2. **Or use the cleanup script**:

   ```bash
   pnpm cleanup:temps       # Delete all orphaned test directories
   pnpm cleanup:temps:dry   # Preview what would be deleted (verbose)
   ```

3. **Verify cleanup** before ending the session:
   ```bash
   ls /tmp | grep -E '^(aligntrue-|test-|ruler-|solo-test|team-)'
   # Should return empty or only very recent directories
   ```

Automated tests clean up via `afterEach` hooks, but interrupted tests and manual sessions often leave orphans. The cleanup script matches these patterns:

- `aligntrue-*` (all test/backup/perf directories)
- `test-*` (exploratory testing)
- `ruler-*`, `solo-test*`, `team-*` (specific test types)
- `exploratory-*`, `split-test*` (manual testing)

### Safety verification

Structured tests now assert:

- Current directory is under `/tmp/`
- TEST_WORKSPACE env var points to the temp directory
- ALIGNTRUE_CLI env var targets the built CLI
- LOG_FILE env var is set for capturing logs

---

## Handling core format or path changes

When changing core formats or paths:

1. **Search affected tests:**

```bash
grep -r "old-path-or-pattern" packages/*/tests/
```

2. **Update:**
   - File paths
   - Expectations
   - Config references

3. **Run targeted and full suites:**

```bash
pnpm --filter @aligntrue/cli test
pnpm test
```

Same PR must update tests. No "fix tests later."

---

## Test coverage strategy

Design a tight red green path covering:

- **Determinism:** fixed seeds, stable sort, byte identical exports where relevant
- **Boundaries:** missing files, invalid schema, corrupt data, wrong types
- **Integration:** config loading, bundling, exporters, MCP server, CLI wiring
- **Performance sanity:** fast unit tests by default, heavy paths behind marks

---

## TDD workflow

Use TDD for new deterministic features.

1. Write contract tests first
2. Keep fixtures minimal and local
3. Use temp dirs and helpers
4. Implement only what tests require
5. Run with `TZ=UTC` for everything

### Standard

```bash
TZ=UTC pnpm test --silent
TZ=UTC pnpm --filter @aligntrue/cli vitest run <file> -t "<name>"
```

---

## Determinism checklist (for tests and code)

- `TZ=UTC` for CI
- No raw `Date.now()` or `Math.random()` in deterministic paths
- Stable sort for set like arrays
- Newlines normalized to `\n`
- Use shared canonicalization helpers where applicable

---

## CI quality gates

CI should enforce:

- Lint clean
- `tsc --noEmit` clean
- Tests green
- No lingering `test.skip` or `test.todo` for shipped features

---

## Related rules

- `debugging.mdc` for systematic debugging
- `implementation_specs.mdc` for determinism rules and IR data flow
- `security_linting_policy.mdc` for security linting policy
